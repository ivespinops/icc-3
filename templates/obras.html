{% extends "base.html" %}

{% block title %}M√≥dulo Obras - Constructora ICC{% endblock %}

{% block content %}
<div class="welcome">
    <h2>M√≥dulo de Obras</h2>
    <p>Gesti√≥n y administraci√≥n de obras de la constructora</p>
</div>

<div class="card">
    <h3>Informaci√≥n del Usuario</h3>
    <div class="user-info">
        <p><strong>Usuario:</strong> {{ user.name }}</p>
        <p><strong>Email:</strong> {{ user.email }}</p>
        <p><strong>Rol:</strong>
            {% if user.is_admin %}Administrador{% endif %}
            {% if user.is_manager %}Gerente{% endif %}
            {% if user.is_admin_obra %}Admin Obra{% endif %}
        </p>
    </div>
</div>

<div class="card">
    <h3>Funcionalidades del M√≥dulo Obras</h3>
    <div class="module-functions">
        <p>‚Ä¢ Gesti√≥n de obras activas</p>
        <p>‚Ä¢ Control de avance de obras</p>
        <p>‚Ä¢ Administraci√≥n de recursos</p>
        <p>‚Ä¢ Reportes de obras</p>
        <p>‚Ä¢ Asignaci√≥n de personal</p>
    </div>
</div>

<div class="card">
    <h3>Acciones Disponibles</h3>
    <div class="actions">
        {% if user.is_admin %}
        <p>‚Ä¢ <strong>Administrador:</strong> Acceso completo a todas las funciones</p>
        <p>‚Ä¢ <a href="/obras/crear" style="color: #0066cc;">‚ûï Crear Nueva Obra</a></p>
        {% endif %}
        {% if user.is_manager %}
        <p>‚Ä¢ <strong>Gerente:</strong> Supervisi√≥n y aprobaci√≥n de obras</p>
        <p>‚Ä¢ <a href="/obras/crear" style="color: #0066cc;">‚ûï Crear Nueva Obra</a></p>
        {% endif %}
        {% if user.is_admin_obra %}
        <p>‚Ä¢ <strong>Admin Obra:</strong> Gesti√≥n operativa de obras espec√≠ficas</p>
        {% endif %}
        <p>‚Ä¢ <a href="#" id="listarObras" style="color: #0066cc;">üìã Ver Lista de Obras</a></p>
    </div>
</div>

<div class="card" id="obrasContainer" style="display: none;">
    <h3>Lista de Obras</h3>
    <div id="obrasContent">
        <!-- El contenido se cargar√° din√°micamente -->
    </div>
</div>

<div class="card">
    <h3>Navegaci√≥n</h3>
    <p>‚Ä¢ Volver al <a href="/dashboard" style="color: #0066cc;">Dashboard Principal</a></p>
</div>

<script>
document.getElementById('listarObras').addEventListener('click', async function(e) {
    e.preventDefault();

    const obrasContainer = document.getElementById('obrasContainer');
    const obrasContent = document.getElementById('obrasContent');

    try {
        const response = await fetch('/obras/lista');
        const data = await response.json();

        if (data.obras && data.obras.length > 0) {
            let html = `
                <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                    <thead>
                        <tr style="background-color: #f8f9fa;">
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Nombre de Obra</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Centro de Costo</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Administrador</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Fecha Creaci√≥n</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            data.obras.forEach(obra => {
                const fecha = new Date(obra.created_at).toLocaleDateString('es-CL');
                html += `
                    <tr>
                        <td style="border: 1px solid #ddd; padding: 8px;">
                            <a href="/obras/${obra.id}" style="color: #0066cc; text-decoration: none;">
                                ${obra.nombre_obra}
                            </a>
                        </td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${obra.centro_costo}</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${obra.administrador_nombre}</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${fecha}</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            obrasContent.innerHTML = html;
        } else {
            obrasContent.innerHTML = '<p style="color: #666; font-style: italic;">No hay obras registradas.</p>';
        }

        obrasContainer.style.display = 'block';

    } catch (error) {
        console.error('Error:', error);
        obrasContent.innerHTML = '<p style="color: #dc3545;">Error al cargar las obras.</p>';
        obrasContainer.style.display = 'block';
    }
});
</script>
{% endblock %}