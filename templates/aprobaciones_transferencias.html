{% extends "base.html" %}

{% block title %}Transferencias - Constructora ICC{% endblock %}

{% block content %}
<div class="welcome">
    <h2>Transferencias</h2>
    <p>Vista de transferencias basada en la planilla de pagos</p>
</div>

<div class="card">
    <h3>Datos de Transferencias</h3>
    <p>Información de transferencias extraída de la planilla de pagos con las columnas: Rut, Razón Social, Cuenta destino, Monto transferencia y Glosa personalizada transferencia.</p>
    
    <div id="loading" class="loading" style="display: none;">
        <div class="spinner"></div>
        <p>Cargando datos de transferencias...</p>
    </div>
    
    <button id="cargarDatos" class="btn btn-primary" style="margin: 10px 0;">
        Cargar Datos de Transferencias
    </button>
    
    <!-- Controles de Saldo -->
    <div id="controlesTransferencia" class="card" style="display: none; margin-top: 20px; background-color: #1a202c; border: 1px solid #4a5568; padding: 20px;">
        <h4 style="color: white; margin-bottom: 15px;">Control de Transferencias</h4>
        <div style="display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
            <div>
                <label for="saldoCC" style="color: white; display: block; margin-bottom: 5px;">Saldo Cuenta Corriente:</label>
                <input type="number" id="saldoCC" placeholder="Ingrese saldo" style="padding: 8px; width: 200px; border: 1px solid #4a5568; border-radius: 4px; background-color: #2d3748; color: white;">
            </div>
            <div style="color: white;">
                <strong>Transferido:</strong> <span id="totalTransferido" style="color: #48bb78;">$0</span>
            </div>
            <div style="color: white;">
                <strong>Saldo Restante:</strong> <span id="saldoRestante" style="color: #63b3ed;">$0</span>
            </div>
            <button id="guardarDatos" class="btn btn-success" style="background-color: #48bb78; border-color: #48bb78;">
                Guardar Cambios
            </button>
        </div>
    </div>
    
    <div id="estadisticas" class="card" style="display: none; margin-top: 20px;">
        <h4>Estadísticas</h4>
        <div id="stats-content"></div>
    </div>
    
    <div id="mensaje" style="margin-top: 20px;"></div>
</div>

<div id="transferenciasData" class="card" style="display: none;">
    <h3>Datos de Transferencias</h3>
    <div style="margin: 10px 0;">
        <input type="text" id="buscar" placeholder="Buscar por RUT o Razón Social..." style="padding: 8px; width: 300px; margin-right: 10px;">
        <button id="exportarCSV" class="btn btn-secondary">Exportar CSV</button>
    </div>
    
    <div style="overflow-x: auto; max-height: 600px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px;">
        <table id="transferenciasTable" style="width: 100%; border-collapse: collapse; background-color: #2d3748; color: white;">
            <thead style="background-color: #1a202c; position: sticky; top: 0; z-index: 10;">
                <tr>
                    <th style="padding: 12px; border: 1px solid #4a5568; text-align: left; min-width: 120px; background-color: #1a202c;">RUT</th>
                    <th style="padding: 12px; border: 1px solid #4a5568; text-align: left; min-width: 120px; background-color: #1a202c;">Razón Social</th>
                    <th style="padding: 12px; border: 1px solid #4a5568; text-align: left; min-width: 120px; background-color: #1a202c;">Cuenta Destino</th>
                    <th style="padding: 12px; border: 1px solid #4a5568; text-align: left; min-width: 120px; background-color: #1a202c;">Monto Transferencia</th>
                    <th style="padding: 12px; border: 1px solid #4a5568; text-align: left; min-width: 120px; background-color: #1a202c;">Glosa Personalizada Transferencia</th>
                    <th style="padding: 12px; border: 1px solid #4a5568; text-align: center; min-width: 100px; background-color: #1a202c;">Transferido</th>
                    <th style="padding: 12px; border: 1px solid #4a5568; text-align: left; min-width: 150px; background-color: #1a202c;">Fecha Transferencia</th>
                </tr>
            </thead>
            <tbody id="transferenciasTableBody">
            </tbody>
        </table>
    </div>
    
    <div id="paginacion" style="margin-top: 20px; text-align: center;">
        <button id="anteriorPagina" class="btn btn-small">Anterior</button>
        <span id="infoPagina"></span>
        <button id="siguientePagina" class="btn btn-small">Siguiente</button>
    </div>
</div>

<style>
.loading {
    text-align: center;
    padding: 20px;
}

.spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #3498db;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 0 auto 10px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}


.btn-small {
    padding: 5px 10px;
    font-size: 12px;
    margin: 0 5px;
}

.alert {
    padding: 10px;
    margin: 10px 0;
    border-radius: 4px;
}

.alert-info {
    background-color: #d9edf7;
    border: 1px solid #bce8f1;
    color: #31708f;
}

.alert-warning {
    background-color: #fcf8e3;
    border: 1px solid #faebcc;
    color: #8a6d3b;
}

.alert-error {
    background-color: #f2dede;
    border: 1px solid #ebccd1;
    color: #a94442;
}
</style>

<script>
let datosCompletos = [];
let datosFiltrados = [];
let paginaActual = 1;
const registrosPorPagina = 50;
let saldoCuentaCorriente = 0;

document.addEventListener('DOMContentLoaded', function() {
    const btnCargar = document.getElementById('cargarDatos');
    const btnExportar = document.getElementById('exportarCSV');
    const btnGuardar = document.getElementById('guardarDatos');
    const buscarInput = document.getElementById('buscar');
    const saldoInput = document.getElementById('saldoCC');
    const btnAnterior = document.getElementById('anteriorPagina');
    const btnSiguiente = document.getElementById('siguientePagina');
    
    btnCargar.addEventListener('click', cargarDatos);
    btnExportar.addEventListener('click', exportarCSV);
    btnGuardar.addEventListener('click', guardarDatos);
    buscarInput.addEventListener('input', filtrarDatos);
    saldoInput.addEventListener('input', calcularSaldos);
    
    // Cargar metadatos al iniciar
    cargarMetadatos();
});

async function cargarDatos() {
    const loading = document.getElementById('loading');
    const btnCargar = document.getElementById('cargarDatos');
    const mensaje = document.getElementById('mensaje');
    
    try {
        loading.style.display = 'block';
        btnCargar.disabled = true;
        mensaje.innerHTML = '';
        
        const response = await fetch('/api/aprobaciones/transferencias');
        const result = await response.json();
        
        if (!response.ok) {
            throw new Error(result.detail || 'Error al cargar datos');
        }
        
        datosCompletos = result.data || [];
        datosFiltrados = [...datosCompletos];
        
        if (datosCompletos.length === 0) {
            mensaje.innerHTML = `<div class="alert alert-warning">${result.message || 'No hay datos disponibles'}</div>`;
            return;
        }
        
        mostrarEstadisticas(result);
        mostrarTabla();
        calcularSaldos();
        
        document.getElementById('transferenciasData').style.display = 'block';
        document.getElementById('estadisticas').style.display = 'block';
        document.getElementById('controlesTransferencia').style.display = 'block';
        
    } catch (error) {
        console.error('Error:', error);
        mensaje.innerHTML = `<div class="alert alert-error">❌ Error al cargar datos: ${error.message}</div>`;
    } finally {
        loading.style.display = 'none';
        btnCargar.disabled = false;
    }
}

function mostrarEstadisticas(result) {
    const statsContent = document.getElementById('stats-content');
    const totalRegistros = result.total_records || 0;
    const columnas = result.columns || [];
    
    const registrosConCuenta = datosCompletos.filter(row => 
        row['Cuenta destino'] && row['Cuenta destino'] !== null && row['Cuenta destino'] !== ''
    ).length;
    
    const registrosSinCuenta = totalRegistros - registrosConCuenta;
    
    statsContent.innerHTML = `
        <p><strong>Total de registros:</strong> ${totalRegistros}</p>
        <p><strong>Registros con cuenta destino:</strong> ${registrosConCuenta}</p>
        <p><strong>Registros sin cuenta destino:</strong> ${registrosSinCuenta}</p>
        <p><strong>Columnas disponibles:</strong> ${columnas.join(', ')}</p>
    `;
}

function mostrarTabla() {
    const tbody = document.getElementById('transferenciasTableBody');
    
    // Mostrar todos los registros (sin paginación)
    const datosPagina = datosFiltrados;
    
    tbody.innerHTML = '';
    
    datosPagina.forEach((row, index) => {
        const tr = document.createElement('tr');
        tr.style.cssText = `background-color: ${index % 2 === 0 ? '#2d3748' : '#4a5568'}; border-bottom: 1px solid #4a5568;`;
        
        const fechaTransferencia = row['Fecha Transferencia'] ? new Date(row['Fecha Transferencia']).toLocaleString('es-CL') : '';
        
        tr.innerHTML = `
            <td style="padding: 8px; border: 1px solid #4a5568; min-width: 120px;">${row['Rut'] || ''}</td>
            <td style="padding: 8px; border: 1px solid #4a5568; min-width: 120px;">${row['Razón Social'] || ''}</td>
            <td style="padding: 8px; border: 1px solid #4a5568; min-width: 120px;">${row['Cuenta destino'] || ''}</td>
            <td style="padding: 8px; border: 1px solid #4a5568; min-width: 120px; text-align: right;">${row['Monto transferencia'] ? '$' + Number(row['Monto transferencia']).toLocaleString('es-CL') : ''}</td>
            <td style="padding: 8px; border: 1px solid #4a5568; min-width: 120px;">${row['Glosa personalizada transferencia'] || ''}</td>
            <td style="padding: 8px; border: 1px solid #4a5568; min-width: 100px; text-align: center;">
                <input type="checkbox" ${row['Transferido'] ? 'checked' : ''} 
                       onchange="marcarTransferido(${index}, this.checked)" 
                       style="transform: scale(1.2); cursor: pointer;">
            </td>
            <td style="padding: 8px; border: 1px solid #4a5568; min-width: 150px; font-size: 12px;">${fechaTransferencia}</td>
        `;
        tbody.appendChild(tr);
    });
    
    actualizarInfoRegistros();
}

function filtrarDatos() {
    const termino = document.getElementById('buscar').value.toLowerCase();
    
    if (!termino) {
        datosFiltrados = [...datosCompletos];
    } else {
        datosFiltrados = datosCompletos.filter(row => {
            const rut = (row['Rut'] || '').toString().toLowerCase();
            const razonSocial = (row['Razón Social'] || '').toString().toLowerCase();
            return rut.includes(termino) || razonSocial.includes(termino);
        });
    }
    
    mostrarTabla();
}

function actualizarInfoRegistros() {
    const infoPagina = document.getElementById('infoPagina');
    const btnAnterior = document.getElementById('anteriorPagina');
    const btnSiguiente = document.getElementById('siguientePagina');
    
    infoPagina.textContent = `Mostrando ${datosFiltrados.length} registros`;
    // Ocultar botones de paginación
    btnAnterior.style.display = 'none';
    btnSiguiente.style.display = 'none';
}

async function cargarMetadatos() {
    try {
        const response = await fetch('/api/aprobaciones/transferencias/metadata');
        const metadata = await response.json();
        
        if (metadata.saldo_cuenta_corriente) {
            document.getElementById('saldoCC').value = metadata.saldo_cuenta_corriente;
            saldoCuentaCorriente = metadata.saldo_cuenta_corriente;
        }
        
    } catch (error) {
        console.error('Error al cargar metadatos:', error);
    }
}

function marcarTransferido(index, checked) {
    if (index < datosFiltrados.length) {
        datosFiltrados[index]['Transferido'] = checked;
        
        if (checked) {
            datosFiltrados[index]['Fecha Transferencia'] = new Date().toISOString();
        } else {
            datosFiltrados[index]['Fecha Transferencia'] = null;
        }
        
        // Actualizar también en datosCompletos
        const rutBuscado = datosFiltrados[index]['Rut'];
        const itemCompleto = datosCompletos.find(item => item['Rut'] === rutBuscado);
        if (itemCompleto) {
            itemCompleto['Transferido'] = checked;
            itemCompleto['Fecha Transferencia'] = datosFiltrados[index]['Fecha Transferencia'];
        }
        
        calcularSaldos();
        mostrarTabla(); // Refrescar la tabla para mostrar la fecha actualizada
    }
}

function calcularSaldos() {
    saldoCuentaCorriente = parseFloat(document.getElementById('saldoCC').value) || 0;
    
    const totalTransferido = datosCompletos
        .filter(row => row['Transferido'])
        .reduce((sum, row) => sum + (parseFloat(row['Monto transferencia']) || 0), 0);
    
    const saldoRestante = saldoCuentaCorriente - totalTransferido;
    
    document.getElementById('totalTransferido').textContent = '$' + totalTransferido.toLocaleString('es-CL');
    document.getElementById('saldoRestante').textContent = '$' + saldoRestante.toLocaleString('es-CL');
    
    // Cambiar color según el saldo
    const saldoElement = document.getElementById('saldoRestante');
    if (saldoRestante < 0) {
        saldoElement.style.color = '#f56565'; // Rojo
    } else if (saldoRestante === 0) {
        saldoElement.style.color = '#ed8936'; // Naranja
    } else {
        saldoElement.style.color = '#63b3ed'; // Azul
    }
}

async function guardarDatos() {
    const btnGuardar = document.getElementById('guardarDatos');
    const mensaje = document.getElementById('mensaje');
    
    try {
        btnGuardar.disabled = true;
        btnGuardar.textContent = 'Guardando...';
        
        const response = await fetch('/api/aprobaciones/transferencias/guardar', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                data: datosCompletos,
                saldo_cc: saldoCuentaCorriente
            })
        });
        
        const result = await response.json();
        
        if (!response.ok) {
            throw new Error(result.detail || 'Error al guardar datos');
        }
        
        mensaje.innerHTML = `<div class="alert alert-info" style="background-color: #d9edf7; border: 1px solid #bce8f1; color: #31708f; padding: 10px; margin: 10px 0; border-radius: 4px;">✅ ${result.message}</div>`;
        
        // Ocultar el mensaje después de 3 segundos
        setTimeout(() => {
            mensaje.innerHTML = '';
        }, 3000);
        
    } catch (error) {
        console.error('Error:', error);
        mensaje.innerHTML = `<div class="alert alert-error">❌ Error al guardar: ${error.message}</div>`;
    } finally {
        btnGuardar.disabled = false;
        btnGuardar.textContent = 'Guardar Cambios';
    }
}

function exportarCSV() {
    if (datosFiltrados.length === 0) {
        alert('No hay datos para exportar');
        return;
    }
    
    const headers = ['RUT', 'Razón Social', 'Cuenta Destino', 'Monto Transferencia', 'Glosa Personalizada Transferencia', 'Transferido', 'Fecha Transferencia'];
    const csvContent = [
        headers.join(','),
        ...datosFiltrados.map(row => [
            `"${row['Rut'] || ''}"`,
            `"${row['Razón Social'] || ''}"`,
            `"${row['Cuenta destino'] || ''}"`,
            `"${row['Monto transferencia'] || ''}"`,
            `"${row['Glosa personalizada transferencia'] || ''}"`,
            `"${row['Transferido'] ? 'Sí' : 'No'}"`,
            `"${row['Fecha Transferencia'] ? new Date(row['Fecha Transferencia']).toLocaleString('es-CL') : ''}"`
        ].join(','))
    ].join('\n');
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    
    link.setAttribute('href', url);
    link.setAttribute('download', `transferencias_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
</script>
{% endblock %}